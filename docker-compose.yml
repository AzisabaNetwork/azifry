---
version: '3.1'

services:
  # バックアップ
  backup:
    build: ./img/+backup
    secrets:
      - restic
      - restic-sftp-private-key
      - restic-sftp-hosts
      - mysql-admin
    environment:
      TZ: Asia/Tokyo
      RESTIC_PASSWORD_FILE: '/run/secrets/restic'
      SFTP_PRIVATE_KEY: '/run/secrets/restic-sftp-private-key'
      SFTP_HOSTS: '/run/secrets/restic-sftp-hosts'
      DB_HOST: 'database'
      DB_USER: 'admin'
      DB_PASSWORD_FILE: '/run/secrets/mysql-admin'
    volumes:
      - '/opt/minecraft/bungee:/app/bungee:ro'
      - '/opt/minecraft/lobby:/app/lobby:ro'
      - '/opt/minecraft/main:/app/main:ro'
      - '/opt/minecraft/parkour:/app/parkour:ro'
      - '/opt/minecraft/lgw:/app/lgw:ro'
      - '/opt/minecraft/pvp:/app/pvp:ro'
      - '/opt/minecraft/wave:/app/wave:ro'
      - '/opt/minecraft/life:/app/life:ro'
      - '/opt/resourcepacks:/app/resourcepacks:ro'
      - '/srv/discord:/app/discord:ro'
      - '/srv/html:/app/html:ro'
      - '/srv/letsencrypt:/app/letsencrypt:ro'
      - '/srv/mysql:/app/mysql:ro'
      - '/srv/secrets:/app/secrets:ro'
    working_dir: '/app'
  # データベース
  database:
    build: ./img/@mariadb
    restart: always
    ports:
      - 3306:3306
    environment:
      TZ: Asia/Tokyo
    volumes:
      - './cnf/my.cnf:/etc/my.cnf.d/azi.cnf:ro'
      - '/srv/mysql:/var/lib/mysql'
  # 証明書
  letsencrypt:
    build: ./img/+letsencrypt
    secrets:
      - dns-cloudflare
    environment:
      TZ: Asia/Tokyo
      DOMAINS: 'azisaba.net,*.azisaba.net'
      DNS_CLOUDFLARE_CREDENTIALS: '/run/secrets/dns-cloudflare'
    volumes:
      - '/srv/letsencrypt:/etc/letsencrypt'
  # ウェブ
  web:
    image: nginx:mainline-alpine
    restart: always
    ports:
      - 443:443
    environment:
      TZ: Asia/Tokyo
    volumes:
      - './cnf/nginx.conf:/etc/nginx/conf.d/azi.conf:ro'
      - '/srv/letsencrypt:/app/letsencrypt:ro'
      - '/srv/html/azisaba.net:/app/html/azisaba.net'
      - '/opt/resourcepacks:/app/resourcepacks'
    depends_on:
      - wordpress
  # ホームページ
  wordpress:
    build: ./img/@wordpress
    restart: always
    secrets:
      - mysql-wordpress
    environment:
      TZ: Asia/Tokyo
      WORDPRESS_DB_HOST: database
      WORDPRESS_DB_USER: 'wordpress'
      WORDPRESS_DB_PASSWORD_FILE: '/run/secrets/mysql-wordpress'
      WORDPRESS_DB_NAME: 'azisaba_wordpress'
    volumes:
      - './cnf/php.ini:/usr/local/etc/php/php.ini:ro'
      - './cnf/php-fpm.conf:/usr/local/etc/php-fpm.d/zzz-www.conf:ro'
      - '/srv/html/azisaba.net:/app/html/azisaba.net'
    depends_on:
      - database
  # WebP作成
  wordpress-webp:
    build: ./img/+webp
    environment:
      TZ: Asia/Tokyo
    volumes:
      - '/srv/html/azisaba.net/wp-content/uploads:/app/wordpress-webp'
    working_dir: '/app/wordpress-webp'
  # アジ鯖サポート
  support:
    build: ./img/discord.py
    restart: always
    environment:
      TZ: Asia/Tokyo
    volumes:
      - '/srv/discord/support:/app/support'
    working_dir: '/app/support'
    command: '-u support.py'
  # 名前に色付けるやつ
  colorful:
    build: ./img/discord.py
    restart: always
    environment:
      TZ: Asia/Tokyo
    volumes:
      - '/srv/discord/colorful-discord:/app/colorful'
    working_dir: '/app/colorful'
    command: '-u colorful.py'
  # Minecraft - bungee (プロキシサーバー)
  bungee:
    build: ./img/minecraft
    restart: always
    ports:
      - 8192:8192
      - 25565:25577
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'Waterfall.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/waterfall/1.15/latest/download'
      JVM_ARGS: '-Dminecraft@bungee -XX:+UseShenandoahGC -Xloggc:./gc.log'
    volumes:
      - '/opt/minecraft/bungee:/app/bungee'
    working_dir: '/app/bungee'
  # Minecraft - lobby (ロビーサーバー)
  lobby:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.8.8.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.8.8/latest/download'
      JVM_ARGS: '-Dminecraft@lobby -XX:+UseShenandoahGC -Xloggc:./gc.log'
      STOP_CMD: 'minecraft:stop'
    volumes:
      - '/opt/minecraft/lobby:/app/lobby'
    working_dir: '/app/lobby'
  # Minecraft - main (生活サーバー)
  main:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.15.2.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.15.2/latest/download'
      JVM_ARGS: '-Dminecraft@main -XX:+UseShenandoahGC -Xloggc:./gc.log'
      LAZY_STARTUP: 'yes'
    volumes:
      - '/opt/minecraft/main:/app/main'
    working_dir: '/app/main'
  # Minecraft - parkour (パルクールサーバー)
  parkour:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.13.2.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.13.2/latest/download'
      JVM_ARGS: '-Dminecraft@parkour -XX:+UseShenandoahGC -Xloggc:./gc.log'
      LAZY_STARTUP: 'yes'
    volumes:
      - '/opt/minecraft/parkour:/app/parkour'
    working_dir: '/app/parkour'
  # Minecraft - lgw (銃サーバー)
  lgw:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.12.2.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.12.2/latest/download'
      JVM_ARGS: '-Dminecraft@lgw -XX:+UseShenandoahGC -Xloggc:./gc.log'
      LAZY_STARTUP: 'yes'
    volumes:
      - '/opt/minecraft/lgw:/app/lgw'
    working_dir: '/app/lgw'
  # Minecraft - pvp (PvPサーバー)
  pvp:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.8.8.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.8.8/latest/download'
      JVM_ARGS: '-Dminecraft@pvp -XX:+UseShenandoahGC -Xloggc:./gc.log'
      LAZY_STARTUP: 'yes'
      STOP_CMD: 'minecraft:stop'
    volumes:
      - '/opt/minecraft/pvp:/app/pvp'
    working_dir: '/app/pvp'
  # Minecraft - wave (WavePvEサーバー)
  wave:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.12.2.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.12.2/latest/download'
      JVM_ARGS: '-Dminecraft@wave -XX:+UseShenandoahGC -Xloggc:./gc.log'
      LAZY_STARTUP: 'yes'
    volumes:
      - '/opt/minecraft/wave:/app/wave'
    working_dir: '/app/wave'
  # Minecraft - life (新しい生活サーバー)
  life:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.15.2.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.15.2/latest/download'
      JVM_ARGS: '-Dminecraft@life -XX:+UseShenandoahGC -Xloggc:./gc.log'
      LAZY_STARTUP: 'yes'
    volumes:
      - '/opt/minecraft/life:/app/life'
    working_dir: '/app/life'
  # Minecraft - rpg (MEC式RPGサーバー)
  rpg:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.15.2.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.15.2/latest/download'
      JVM_ARGS: '-Dminecraft@rpg -XX:+UseShenandoahGC -Xloggc:./gc.log'
      LAZY_STARTUP: 'yes'
    volumes:
      - '/opt/minecraft/rpg:/app/rpg'
    working_dir: '/app/rpg'

secrets:
  dns-cloudflare:
    file: /srv/secrets/dns-cloudflare.txt
  restic:
    file: /srv/secrets/restic.txt
  restic-sftp-private-key:
    file: /srv/secrets/restic-sftp-private-key.txt
  restic-sftp-hosts:
    file: /srv/secrets/restic-sftp-hosts.txt
  mysql-admin:
    file: /srv/secrets/mysql-admin.txt
  mysql-wordpress:
    file: /srv/secrets/mysql-wordpress.txt
