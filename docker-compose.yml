---
version: '3.1'

services:
  # バックアップ
  backup:
    build: ./img/#backup
    secrets:
      - restic
      - restic-sftp-private-key
      - restic-sftp-hosts
      - admin
    environment:
      TZ: Asia/Tokyo
      RESTIC_PASSWORD_FILE: '/run/secrets/restic'
      SFTP_PRIVATE_KEY: '/run/secrets/restic-sftp-private-key'
      SFTP_HOSTS: '/run/secrets/restic-sftp-hosts'
      DB_HOST: 'database'
      DB_USER: 'admin'
      DB_PASSWORD_FILE: '/run/secrets/admin'
    volumes:
      - '/opt/minecraft/bungee:/app/bungee:ro'
      - '/opt/minecraft/lobby:/app/lobby:ro'
      - '/opt/minecraft/main:/app/main:ro'
      - '/opt/minecraft/parkour:/app/parkour:ro'
      - '/opt/minecraft/p:/app/p:ro'
      - '/opt/minecraft/lgw:/app/lgw:ro'
      - '/opt/minecraft/pvp:/app/pvp:ro'
      - '/opt/minecraft/pata:/app/pata:ro'
      - '/opt/minecraft/wave:/app/wave:ro'
      - '/opt/resourcepacks:/app/resourcepacks:ro'
      - '/srv/discord:/app/discord:ro'
      - '/srv/html:/app/html:ro'
      - '/srv/letsencrypt:/app/letsencrypt:ro'
      - '/srv/metabase:/app/metabase:ro'
      - '/srv/mysql:/app/mysql:ro'
      - '/srv/secrets:/app/secrets:ro'
    working_dir: '/app'
  # リアルタイムサーバー監視
  netdata:
    image: netdata/netdata:latest
    restart: always
    hostname: 'netdata.azisaba.net'
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    environment:
      TZ: Asia/Tokyo
    volumes:
      - '/proc:/host/proc:ro'
      - '/sys:/host/sys:ro'
      - '/etc/os-release:/host/etc/os-release:ro'
  # データベース
  database:
    build: ./img/@mariadb
    restart: always
    ports:
      - 3306:3306
    environment:
      TZ: Asia/Tokyo
    volumes:
      - './cnf/my.cnf:/etc/my.cnf.d/azi.cnf:ro'
      - '/srv/mysql:/var/lib/mysql'
  # 証明書
  letsencrypt:
    build: ./img/#letsencrypt
    secrets:
      - dns-cloudflare
    environment:
      TZ: Asia/Tokyo
      DOMAINS: 'azisaba.net,*.azisaba.net'
      DNS_CLOUDFLARE_CREDENTIALS: '/run/secrets/dns-cloudflare'
    volumes:
      - '/srv/letsencrypt:/etc/letsencrypt'
  # ウェブ
  web:
    image: nginx:mainline-alpine
    restart: always
    ports:
      - 443:443
    environment:
      TZ: Asia/Tokyo
    volumes:
      - './cnf/nginx.conf:/etc/nginx/conf.d/azi.conf:ro'
      - '/srv/letsencrypt:/app/letsencrypt:ro'
      - '/srv/html/azisaba.net:/app/html/azisaba.net'
      - '/srv/html/maps.azisaba.net:/app/html/maps.azisaba.net'
      - '/opt/resourcepacks:/app/resourcepacks'
    depends_on:
      - wordpress
      - metabase
      - netdata
  # ホームページ
  wordpress:
    build: ./img/@wordpress
    restart: always
    secrets:
      - wordpress
    environment:
      TZ: Asia/Tokyo
      WORDPRESS_DB_HOST: database
      WORDPRESS_DB_USER: 'wordpress'
      WORDPRESS_DB_PASSWORD_FILE: '/run/secrets/wordpress'
      WORDPRESS_DB_NAME: 'azisaba_wordpress'
    volumes:
      - './cnf/php.ini:/usr/local/etc/php/php.ini:ro'
      - './cnf/php-fpm.conf:/usr/local/etc/php-fpm.d/zzz-www.conf:ro'
      - '/srv/html/azisaba.net:/app/html/azisaba.net'
    depends_on:
      - database
  # WebP作成
  wordpress-webp:
    build: ./img/#webp
    environment:
      TZ: Asia/Tokyo
    volumes:
      - '/srv/html/azisaba.net/wp-content/uploads:/app/wordpress-webp'
    working_dir: '/app/wordpress-webp'
  # データ可視化
  metabase:
    image: metabase/metabase:latest
    restart: always
    environment:
      TZ: Asia/Tokyo
      MB_DB_FILE: /app/metabase/metabase.db
    volumes:
      - '/srv/metabase:/app/metabase'
    depends_on:
      - database
  # アジ鯖ロガー
  logger:
    build: ./img/discord.py
    restart: always
    environment:
      TZ: Asia/Tokyo
      SCRIPT_PATH: 'AzisabaLogger.py'
    volumes:
      - '/srv/discord/logger:/app/logger'
    working_dir: '/app/logger'
  # アジ鯖サポート
  support:
    build: ./img/discord.py
    restart: always
    environment:
      TZ: Asia/Tokyo
      SCRIPT_PATH: 'support.py'
    volumes:
      - '/srv/discord/support:/app/support'
    working_dir: '/app/support'
  # Minecraft - bungee (プロキシサーバー)
  bungee:
    build: ./img/minecraft
    restart: always
    ports:
      - 8192:8192
      - 25565:25577
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'BungeeCord.jar'
      JAR_DOWNLOAD_URL: 'https://ci.md-5.net/job/BungeeCord/lastSuccessfulBuild/artifact/bootstrap/target/BungeeCord.jar'
      JVM_ARGS: '-Dminecraft@bungee'
      JAVA_TOOL_OPTIONS: '-Xms3G -Xmx3G -XX:+UseG1GC -XX:+UnlockExperimentalVMOptions -XX:MaxGCPauseMillis=100 -XX:+DisableExplicitGC -XX:TargetSurvivorRatio=90 -XX:G1NewSizePercent=50 -XX:G1MaxNewSizePercent=80 -XX:G1MixedGCLiveThresholdPercent=35 -XX:+AlwaysPreTouch -XX:+ParallelRefProcEnabled -Xloggc:./gc.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps'
    volumes:
      - '/opt/minecraft/bungee:/app/bungee'
    working_dir: '/app/bungee'
    stop_grace_period: 15s
    ulimits:
      core: 0
  # Minecraft - lobby (ロビーサーバー)
  lobby:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.8.8.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.8.8/latest/download'
      JVM_ARGS: '-Dminecraft@lobby'
      JAVA_TOOL_OPTIONS: '-XX:+UseShenandoahGC -Xloggc:./gc.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps'
      STOP_CMD: 'minecraft:stop'
    volumes:
      - '/opt/minecraft/lobby:/app/lobby'
    working_dir: '/app/lobby'
    stop_grace_period: 30s
    ulimits:
      core: 0
  # Minecraft - main (生活サーバー)
  main:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.15.2.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.15.2/latest/download'
      JVM_ARGS: '-Dminecraft@main'
      JAVA_TOOL_OPTIONS: '-XX:+UseShenandoahGC -Xloggc:./gc.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps'
      LAZY_STARTUP: 'yes'
    volumes:
      - '/opt/minecraft/main:/app/main'
    working_dir: '/app/main'
    stop_grace_period: 30s
    ulimits:
      core: 0
  # Minecraft - parkour (パルクールサーバー)
  parkour:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.13.2.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.13.2/latest/download'
      JVM_ARGS: '-Dminecraft@parkour'
      JAVA_TOOL_OPTIONS: '-XX:+UseShenandoahGC -Xloggc:./gc.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps'
      LAZY_STARTUP: 'yes'
    volumes:
      - '/opt/minecraft/parkour:/app/parkour'
    working_dir: '/app/parkour'
    stop_grace_period: 30s
    ulimits:
      core: 0
  # Minecraft - p (観光サーバー)
  p:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.13.2.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.13.2/latest/download'
      JVM_ARGS: '-Dminecraft@p'
      JAVA_TOOL_OPTIONS: '-XX:+UseShenandoahGC -Xloggc:./gc.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps'
      LAZY_STARTUP: 'yes'
    volumes:
      - '/opt/minecraft/p:/app/p'
    working_dir: '/app/p'
    stop_grace_period: 30s
    ulimits:
      core: 0
  # Minecraft - lgw (銃サーバー)
  lgw:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.12.2.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.12.2/latest/download'
      JVM_ARGS: '-Dminecraft@lgw'
      JAVA_TOOL_OPTIONS: '-XX:+UseShenandoahGC -Xloggc:./gc.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps'
      LAZY_STARTUP: 'yes'
    volumes:
      - '/opt/minecraft/lgw:/app/lgw'
    working_dir: '/app/lgw'
    stop_grace_period: 30s
    ulimits:
      core: 0
  # Minecraft - pvp (PvPサーバー)
  pvp:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.8.8.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.8.8/latest/download'
      JVM_ARGS: '-Dminecraft@pvp'
      JAVA_TOOL_OPTIONS: '-XX:+UseShenandoahGC -Xloggc:./gc.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps'
      LAZY_STARTUP: 'yes'
      STOP_CMD: 'minecraft:stop'
    volumes:
      - '/opt/minecraft/pvp:/app/pvp'
    working_dir: '/app/pvp'
    stop_grace_period: 30s
    ulimits:
      core: 0
  # Minecraft - pata (ぱたサーバー)
  pata:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.8.8.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.8.8/latest/download'
      JVM_ARGS: '-Dminecraft@pata'
      JAVA_TOOL_OPTIONS: '-XX:+UseShenandoahGC -Xloggc:./gc.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps'
      LAZY_STARTUP: 'yes'
      STOP_CMD: 'minecraft:stop'
    volumes:
      - '/opt/minecraft/pata:/app/pata'
    working_dir: '/app/pata'
    stop_grace_period: 30s
    ulimits:
      core: 0
  # Minecraft - wave (WavePvEサーバー)
  wave:
    build: ./img/minecraft
    restart: always
    environment:
      TZ: Asia/Tokyo
      JAR_PATH: 'paper-1.12.2.jar'
      JAR_DOWNLOAD_URL: 'https://papermc.io/api/v1/paper/1.12.2/latest/download'
      JVM_ARGS: '-Dminecraft@wave'
      JAVA_TOOL_OPTIONS: '-XX:+UseShenandoahGC -Xloggc:./gc.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps'
      LAZY_STARTUP: 'yes'
    volumes:
      - '/opt/minecraft/wave:/app/wave'
    working_dir: '/app/wave'
    stop_grace_period: 30s
    ulimits:
      core: 0

secrets:
  wordpress:
    file: /srv/secrets/wordpress.txt
  dns-cloudflare:
    file: /srv/secrets/dns-cloudflare.txt
  restic:
    file: /srv/secrets/restic.txt
  restic-sftp-private-key:
    file: /srv/secrets/restic-sftp-private-key.txt
  restic-sftp-hosts:
    file: /srv/secrets/restic-sftp-hosts.txt
  admin:
    file: /srv/secrets/admin.txt
